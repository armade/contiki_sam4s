
#include "contiki-conf.h"
#include "platform-conf.h"
#include "compiler.h"
#include "lib/sensors.h"
#include "Hard_rgb.h"
#include "gpio.h"
#include <stdint.h>

#include "board-peripherals.h"
#ifdef NODE_HARD_LIGHT
/*---------------------------------------------------------------------------*/
#define DEBUG 0
#if DEBUG
#define PRINTF(...) printf(__VA_ARGS__)
#else
#define PRINTF(...)
#endif

static void RGB_TEST(void *data);

RGB_hard_t hard_user_set; // User set value (not modified by brightness)


#define SENSOR_STATUS_DISABLED     0
#define SENSOR_STATUS_INITIALISED  1
#define SENSOR_STATUS_NOT_READY    2
#define SENSOR_STATUS_READY        3

static int Sensor_status = SENSOR_STATUS_DISABLED;


static const uint16_t  gamma_table[] = {
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    0,  0,  0,  0,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
    1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
    1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
    1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
    1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
    1,  1,  1,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,
    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,
    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,
    2,  2,  2,  2,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,
    3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,
    3,  3,  3,  3,  3,  3,  3,  3,  3,  4,  4,  4,  4,  4,  4,  4,
    4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,
    4,  4,  4,  4,  4,  4,  4,  4,  5,  5,  5,  5,  5,  5,  5,  5,
    5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
    5,  5,  5,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,
    6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  7,  7,  7,  7,  7,  7,
    7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,
    8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,
    8,  8,  8,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,
    9,  9,  9,  9,  9,  9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
   10, 10, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11,
   11, 11, 11, 11, 11, 11, 11, 12, 12, 12, 12, 12, 12, 12, 12, 12,
   12, 12, 12, 12, 12, 12, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13,
   13, 13, 13, 13, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14,
   14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16,
   16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17,
   17, 17, 17, 17, 17, 17, 17, 17, 18, 18, 18, 18, 18, 18, 18, 18,
   18, 18, 18, 18, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 20,
   20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21, 21, 21, 21, 21, 21,
   21, 21, 21, 21, 21, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 23,
   23, 23, 23, 23, 23, 23, 23, 23, 23, 24, 24, 24, 24, 24, 24, 24,
   24, 24, 24, 25, 25, 25, 25, 25, 25, 25, 25, 25, 26, 26, 26, 26,
   26, 26, 26, 26, 26, 27, 27, 27, 27, 27, 27, 27, 27, 27, 28, 28,
   28, 28, 28, 28, 28, 28, 28, 29, 29, 29, 29, 29, 29, 29, 29, 29,
   30, 30, 30, 30, 30, 30, 30, 30, 31, 31, 31, 31, 31, 31, 31, 31,
   31, 32, 32, 32, 32, 32, 32, 32, 32, 33, 33, 33, 33, 33, 33, 33,
   33, 34, 34, 34, 34, 34, 34, 34, 35, 35, 35, 35, 35, 35, 35, 35,
   36, 36, 36, 36, 36, 36, 36, 37, 37, 37, 37, 37, 37, 37, 37, 38,
   38, 38, 38, 38, 38, 38, 39, 39, 39, 39, 39, 39, 39, 40, 40, 40,
   40, 40, 40, 40, 41, 41, 41, 41, 41, 41, 41, 42, 42, 42, 42, 42,
   42, 42, 43, 43, 43, 43, 43, 43, 44, 44, 44, 44, 44, 44, 44, 45,
   45, 45, 45, 45, 45, 45, 46, 46, 46, 46, 46, 46, 47, 47, 47, 47,
   47, 47, 48, 48, 48, 48, 48, 48, 48, 49, 49, 49, 49, 49, 49, 50,
   50, 50, 50, 50, 50, 51, 51, 51, 51, 51, 51, 52, 52, 52, 52, 52,
   52, 53, 53, 53, 53, 53, 54, 54, 54, 54, 54, 54, 55, 55, 55, 55,
   55, 55, 56, 56, 56, 56, 56, 56, 57, 57, 57, 57, 57, 58, 58, 58,
   58, 58, 58, 59, 59, 59, 59, 59, 60, 60, 60, 60, 60, 60, 61, 61,
   61, 61, 61, 62, 62, 62, 62, 62, 63, 63, 63, 63, 63, 64, 64, 64,
   64, 64, 64, 65, 65, 65, 65, 65, 66, 66, 66, 66, 66, 67, 67, 67,
   67, 67, 68, 68, 68, 68, 68, 69, 69, 69, 69, 69, 70, 70, 70, 70,
   70, 71, 71, 71, 71, 72, 72, 72, 72, 72, 73, 73, 73, 73, 73, 74,
   74, 74, 74, 74, 75, 75, 75, 75, 76, 76, 76, 76, 76, 77, 77, 77,
   77, 77, 78, 78, 78, 78, 79, 79, 79, 79, 79, 80, 80, 80, 80, 81,
   81, 81, 81, 81, 82, 82, 82, 82, 83, 83, 83, 83, 84, 84, 84, 84,
   84, 85, 85, 85, 85, 86, 86, 86, 86, 87, 87, 87, 87, 87, 88, 88,
   88, 88, 89, 89, 89, 89, 90, 90, 90, 90, 91, 91, 91, 91, 92, 92,
   92, 92, 93, 93, 93, 93, 94, 94, 94, 94, 95, 95, 95, 95, 96, 96,
   96, 96, 97, 97, 97, 97, 98, 98, 98, 98, 99, 99, 99, 99,100,100,
  100,100,101,101,101,101,102,102,102,102,103,103,103,103,104,104,
  104,105,105,105,105,106,106,106,106,107,107,107,107,108,108,108,
  109,109,109,109,110,110,110,110,111,111,111,112,112,112,112,113,
  113,113,113,114,114,114,115,115,115,115,116,116,116,117,117,117,
  117,118,118,118,119,119,119,119,120,120,120,121,121,121,121,122,
  122,122,123,123,123,124,124,124,124,125,125,125,126,126,126,127,
  127,127,127,128,128,128,129,129,129,130,130,130,130,131,131,131,
  132,132,132,133,133,133,134,134,134,134,135,135,135,136,136,136,
  137,137,137,138,138,138,139,139,139,139,140,140,140,141,141,141,
  142,142,142,143,143,143,144,144,144,145,145,145,146,146,146,147,
  147,147,148,148,148,149,149,149,150,150,150,151,151,151,152,152,
  152,153,153,153,154,154,154,155,155,155,156,156,156,157,157,157,
  158,158,158,159,159,159,160,160,161,161,161,162,162,162,163,163,
  163,164,164,164,165,165,165,166,166,167,167,167,168,168,168,169,
  169,169,170,170,170,171,171,172,172,172,173,173,173,174,174,174,
  175,175,176,176,176,177,177,177,178,178,179,179,179,180,180,180,
  181,181,182,182,182,183,183,183,184,184,185,185,185,186,186,187,
  187,187,188,188,188,189,189,190,190,190,191,191,192,192,192,193,
  193,194,194,194,195,195,196,196,196,197,197,197,198,198,199,199,
  199,200,200,201,201,202,202,202,203,203,204,204,204,205,205,206,
  206,206,207,207,208,208,208,209,209,210,210,211,211,211,212,212,
  213,213,213,214,214,215,215,216,216,216,217,217,218,218,219,219,
  219,220,220,221,221,222,222,222,223,223,224,224,225,225,225,226,
  226,227,227,228,228,228,229,229,230,230,231,231,232,232,232,233,
  233,234,234,235,235,236,236,236,237,237,238,238,239,239,240,240,
  240,241,241,242,242,243,243,244,244,245,245,245,246,246,247,247,
  248,248,249,249,250,250,251,251,251,252,252,253,253,254,254,255,
  255,256,256,257,257,258,258,259,259,259,260,260,261,261,262,262,
  263,263,264,264,265,265,266,266,267,267,268,268,269,269,270,270,
  271,271,272,272,273,273,273,274,274,275,275,276,276,277,277,278,
  278,279,279,280,280,281,281,282,282,283,283,284,284,285,285,286,
  286,287,287,288,288,289,290,290,291,291,292,292,293,293,294,294,
  295,295,296,296,297,297,298,298,299,299,300,300,301,301,302,302,
  303,303,304,305,305,306,306,307,307,308,308,309,309,310,310,311,
  311,312,313,313,314,314,315,315,316,316,317,317,318,318,319,320,
  320,321,321,322,322,323,323,324,324,325,326,326,327,327,328,328,
  329,329,330,331,331,332,332,333,333,334,334,335,336,336,337,337,
  338,338,339,339,340,341,341,342,342,343,343,344,345,345,346,346,
  347,347,348,349,349,350,350,351,351,352,353,353,354,354,355,356,
  356,357,357,358,358,359,360,360,361,361,362,363,363,364,364,365,
  365,366,367,367,368,368,369,370,370,371,371,372,373,373,374,374,
  375,376,376,377,377,378,379,379,380,380,381,382,382,383,384,384,
  385,385,386,387,387,388,388,389,390,390,391,392,392,393,393,394,
  395,395,396,397,397,398,398,399,400,400,401,402,402,403,403,404,
  405,405,406,407,407,408,408,409,410,410,411,412,412,413,414,414,
  415,416,416,417,417,418,419,419,420,421,421,422,423,423,424,425,
  425,426,427,427,428,428,429,430,430,431,432,432,433,434,434,435,
  436,436,437,438,438,439,440,440,441,442,442,443,444,444,445,446,
  446,447,448,448,449,450,451,451,452,453,453,454,455,455,456,457,
  457,458,459,459,460,461,461,462,463,463,464,465,466,466,467,468,
  468,469,470,470,471,472,473,473,474,475,475,476,477,477,478,479,
  480,480,481,482,482,483,484,484,485,486,487,487,488,489,489,490,
  491,492,492,493,494,494,495,496,497,497,498,499,500,500,501,502,
  502,503,504,505,505,506,507,508,508,509,510,510,511,512,513,513,
  514,515,516,516,517,518,519,519,520,521,522,522,523,524,525,525,
  526,527,528,528,529,530,531,531,532,533,534,534,535,536,537,537,
  538,539,540,540,541,542,543,543,544,545,546,547,547,548,549,550,
  550,551,552,553,553,554,555,556,557,557,558,559,560,560,561,562,
  563,564,564,565,566,567,567,568,569,570,571,571,572,573,574,575,
  575,576,577,578,579,579,580,581,582,583,583,584,585,586,587,587,
  588,589,590,591,591,592,593,594,595,595,596,597,598,599,599,600,
  601,602,603,604,604,605,606,607,608,608,609,610,611,612,613,613,
  614,615,616,617,618,618,619,620,621,622,623,623,624,625,626,627,
  628,628,629,630,631,632,633,633,634,635,636,637,638,639,639,640,
  641,642,643,644,644,645,646,647,648,649,650,650,651,652,653,654,
  655,656,656,657,658,659,660,661,662,663,663,664,665,666,667,668,
  669,669,670,671,672,673,674,675,676,677,677,678,679,680,681,682,
  683,684,684,685,686,687,688,689,690,691,692,692,693,694,695,696,
  697,698,699,700,701,701,702,703,704,705,706,707,708,709,710,710,
  711,712,713,714,715,716,717,718,719,720,721,721,722,723,724,725,
  726,727,728,729,730,731,732,732,733,734,735,736,737,738,739,740,
  741,742,743,744,745,746,746,747,748,749,750,751,752,753,754,755,
  756,757,758,759,760,761,762,763,763,764,765,766,767,768,769,770,
  771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,
  786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,801,
  802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,
  818,819,820,821,822,823,824,825,826,827,828,829,830,831,832,833,
  834,835,836,837,838,839,840,841,842,843,844,845,846,847,848,849,
  850,851,852,853,854,855,856,857,858,859,860,861,862,863,864,865,
  867,868,869,870,871,872,873,874,875,876,877,878,879,880,881,882,
  883,884,885,886,887,888,889,890,892,893,894,895,896,897,898,899,
  900,901,902,903,904,905,906,907,908,909,911,912,913,914,915,916,
  917,918,919,920,921,922,923,924,926,927,928,929,930,931,932,933,
  934,935,936,937,939,940,941,942,943,944,945,946,947,948,949,950,
  952,953,954,955,956,957,958,959,960,961,963,964,965,966,967,968,
  969,970,971,973,974,975,976,977,978,979,980,981,983,984,985,986,
  987,988,989,990,992,993,994,995,996,997,998,999,1001,1002,1003,1004,
  1005,1006,1007,1009,1010,1011,1012,1013,1014,1015,1017,1018,1019,1020,1021,1022,
  1023,1025,1026,1027,1028,1029,1030,1031,1033,1034,1035,1036,1037,1038,1040,1041,
  1042,1043,1044,1045,1047,1048,1049,1050,1051,1052,1054,1055,1056,1057,1058,1059,
  1061,1062,1063,1064,1065,1066,1068,1069,1070,1071,1072,1074,1075,1076,1077,1078,
  1079,1081,1082,1083,1084,1085,1087,1088,1089,1090,1091,1093,1094,1095,1096,1097,
  1099,1100,1101,1102,1103,1105,1106,1107,1108,1109,1111,1112,1113,1114,1115,1117,
  1118,1119,1120,1122,1123,1124,1125,1126,1128,1129,1130,1131,1133,1134,1135,1136,
  1137,1139,1140,1141,1142,1144,1145,1146,1147,1149,1150,1151,1152,1153,1155,1156,
  1157,1158,1160,1161,1162,1163,1165,1166,1167,1168,1170,1171,1172,1173,1175,1176,
  1177,1178,1180,1181,1182,1183,1185,1186,1187,1189,1190,1191,1192,1194,1195,1196,
  1197,1199,1200,1201,1202,1204,1205,1206,1208,1209,1210,1211,1213,1214,1215,1217,
  1218,1219,1220,1222,1223,1224,1226,1227,1228,1229,1231,1232,1233,1235,1236,1237,
  1238,1240,1241,1242,1244,1245,1246,1248,1249,1250,1252,1253,1254,1255,1257,1258,
  1259,1261,1262,1263,1265,1266,1267,1269,1270,1271,1273,1274,1275,1277,1278,1279,
  1280,1282,1283,1284,1286,1287,1288,1290,1291,1292,1294,1295,1296,1298,1299,1300,
  1302,1303,1304,1306,1307,1309,1310,1311,1313,1314,1315,1317,1318,1319,1321,1322,
  1323,1325,1326,1327,1329,1330,1331,1333,1334,1336,1337,1338,1340,1341,1342,1344,
  1345,1347,1348,1349,1351,1352,1353,1355,1356,1357,1359,1360,1362,1363,1364,1366,
  1367,1369,1370,1371,1373,1374,1375,1377,1378,1380,1381,1382,1384,1385,1387,1388,
  1389,1391,1392,1394,1395,1396,1398,1399,1401,1402,1403,1405,1406,1408,1409,1410,
  1412,1413,1415,1416,1418,1419,1420,1422,1423,1425,1426,1427,1429,1430,1432,1433,
  1435,1436,1437,1439,1440,1442,1443,1445,1446,1447,1449,1450,1452,1453,1455,1456,
  1458,1459,1460,1462,1463,1465,1466,1468,1469,1471,1472,1473,1475,1476,1478,1479,
  1481,1482,1484,1485,1487,1488,1489,1491,1492,1494,1495,1497,1498,1500,1501,1503,
  1504,1506,1507,1509,1510,1511,1513,1514,1516,1517,1519,1520,1522,1523,1525,1526,
  1528,1529,1531,1532,1534,1535,1537,1538,1540,1541,1543,1544,1546,1547,1549,1550,
  1552,1553,1555,1556,1558,1559,1561,1562,1564,1565,1567,1568,1570,1571,1573,1574,
  1576,1577,1579,1580,1582,1583,1585,1586,1588,1589,1591,1592,1594,1596,1597,1599,
  1600,1602,1603,1605,1606,1608,1609,1611,1612,1614,1615,1617,1619,1620,1622,1623,
  1625,1626,1628,1629,1631,1632,1634,1636,1637,1639,1640,1642,1643,1645,1646,1648,
  1650,1651,1653,1654,1656,1657,1659,1661,1662,1664,1665,1667,1668,1670,1672,1673,
  1675,1676,1678,1679,1681,1683,1684,1686,1687,1689,1690,1692,1694,1695,1697,1698,
  1700,1702,1703,1705,1706,1708,1710,1711,1713,1714,1716,1718,1719,1721,1722,1724,
  1726,1727,1729,1730,1732,1734,1735,1737,1738,1740,1742,1743,1745,1747,1748,1750,
  1751,1753,1755,1756,1758,1760,1761,1763,1764,1766,1768,1769,1771,1773,1774,1776,
  1777,1779,1781,1782,1784,1786,1787,1789,1791,1792,1794,1796,1797,1799,1800,1802,
  1804,1805,1807,1809,1810,1812,1814,1815,1817,1819,1820,1822,1824,1825,1827,1829,
  1830,1832,1834,1835,1837,1839,1840,1842,1844,1845,1847,1849,1850,1852,1854,1855,
  1857,1859,1861,1862,1864,1866,1867,1869,1871,1872,1874,1876,1877,1879,1881,1883,
  1884,1886,1888,1889,1891,1893,1894,1896,1898,1900,1901,1903,1905,1906,1908,1910,
  1912,1913,1915,1917,1918,1920,1922,1924,1925,1927,1929,1930,1932,1934,1936,1937,
  1939,1941,1943,1944,1946,1948,1950,1951,1953,1955,1956,1958,1960,1962,1963,1965,
  1967,1969,1970,1972,1974,1976,1977,1979,1981,1983,1984,1986,1988,1990,1992,1993,
  1995,1997,1999,2000,2002,2004,2006,2007,2009,2011,2013,2014,2016,2018,2020,2022,
  2023,2025,2027,2029,2031,2032,2034,2036,2038,2039,2041,2043,2045,2047,2048,2050,
  2052,2054,2056,2057,2059,2061,2063,2065,2066,2068,2070,2072,2074,2075,2077,2079,
  2081,2083,2084,2086,2088,2090,2092,2094,2095,2097,2099,2101,2103,2104,2106,2108,
  2110,2112,2114,2115,2117,2119,2121,2123,2125,2126,2128,2130,2132,2134,2136,2137,
  2139,2141,2143,2145,2147,2149,2150,2152,2154,2156,2158,2160,2162,2163,2165,2167,
  2169,2171,2173,2175,2176,2178,2180,2182,2184,2186,2188,2189,2191,2193,2195,2197,
  2199,2201,2203,2205,2206,2208,2210,2212,2214,2216,2218,2220,2221,2223,2225,2227,
  2229,2231,2233,2235,2237,2239,2240,2242,2244,2246,2248,2250,2252,2254,2256,2258,
  2259,2261,2263,2265,2267,2269,2271,2273,2275,2277,2279,2281,2282,2284,2286,2288,
  2290,2292,2294,2296,2298,2300,2302,2304,2306,2308,2309,2311,2313,2315,2317,2319,
  2321,2323,2325,2327,2329,2331,2333,2335,2337,2339,2341,2343,2345,2346,2348,2350,
  2352,2354,2356,2358,2360,2362,2364,2366,2368,2370,2372,2374,2376,2378,2380,2382,
  2384,2386,2388,2390,2392,2394,2396,2398,2400,2402,2404,2406,2408,2410,2412,2414,
  2416,2418,2420,2422,2424,2426,2428,2430,2432,2434,2436,2438,2440,2442,2444,2446,
  2448,2450,2452,2454,2456,2458,2460,2462,2464,2466,2468,2470,2472,2474,2476,2478,
  2480,2482,2484,2486,2488,2490,2492,2494,2496,2498,2500,2502,2504,2506,2508,2511,
  2513,2515,2517,2519,2521,2523,2525,2527,2529,2531,2533,2535,2537,2539,2541,2543,
  2545,2547,2550,2552,2554,2556,2558,2560,2562,2564,2566,2568,2570,2572,2574,2576,
  2579,2581,2583,2585,2587,2589,2591,2593,2595,2597,2599,2601,2604,2606,2608,2610,
  2612,2614,2616,2618,2620,2622,2625,2627,2629,2631,2633,2635,2637,2639,2641,2644,
  2646,2648,2650,2652,2654,2656,2658,2660,2663,2665,2667,2669,2671,2673,2675,2677,
  2680,2682,2684,2686,2688,2690,2692,2695,2697,2699,2701,2703,2705,2707,2710,2712,
  2714,2716,2718,2720,2722,2725,2727,2729,2731,2733,2735,2738,2740,2742,2744,2746,
  2748,2751,2753,2755,2757,2759,2761,2764,2766,2768,2770,2772,2774,2777,2779,2781,
  2783,2785,2788,2790,2792,2794,2796,2798,2801,2803,2805,2807,2809,2812,2814,2816,
  2818,2820,2823,2825,2827,2829,2831,2834,2836,2838,2840,2843,2845,2847,2849,2851,
  2854,2856,2858,2860,2863,2865,2867,2869,2871,2874,2876,2878,2880,2883,2885,2887,
  2889,2892,2894,2896,2898,2900,2903,2905,2907,2909,2912,2914,2916,2918,2921,2923,
  2925,2927,2930,2932,2934,2937,2939,2941,2943,2946,2948,2950,2952,2955,2957,2959,
  2961,2964,2966,2968,2971,2973,2975,2977,2980,2982,2984,2987,2989,2991,2993,2996,
  2998,3000,3003,3005,3007,3009,3012,3014,3016,3019,3021,3023,3026,3028,3030,3032,
  3035,3037,3039,3042,3044,3046,3049,3051,3053,3056,3058,3060,3063,3065,3067,3070,
  3072,3074,3077,3079,3081,3084,3086,3088,3091,3093,3095,3098,3100,3102,3105,3107,
  3109,3112,3114,3116,3119,3121,3123,3126,3128,3130,3133,3135,3137,3140,3142,3145,
  3147,3149,3152,3154,3156,3159,3161,3163,3166,3168,3171,3173,3175,3178,3180,3182,
  3185,3187,3190,3192,3194,3197,3199,3202,3204,3206,3209,3211,3214,3216,3218,3221,
  3223,3226,3228,3230,3233,3235,3238,3240,3242,3245,3247,3250,3252,3254,3257,3259,
  3262,3264,3267,3269,3271,3274,3276,3279,3281,3283,3286,3288,3291,3293,3296,3298,
  3301,3303,3305,3308,3310,3313,3315,3318,3320,3323,3325,3327,3330,3332,3335,3337,
  3340,3342,3345,3347,3350,3352,3354,3357,3359,3362,3364,3367,3369,3372,3374,3377,
  3379,3382,3384,3387,3389,3391,3394,3396,3399,3401,3404,3406,3409,3411,3414,3416,
  3419,3421,3424,3426,3429,3431,3434,3436,3439,3441,3444,3446,3449,3451,3454,3456,
  3459,3461,3464,3466,3469,3471,3474,3476,3479,3482,3484,3487,3489,3492,3494,3497,
  3499,3502,3504,3507,3509,3512,3514,3517,3519,3522,3525,3527,3530,3532,3535,3537,
  3540,3542,3545,3548,3550,3553,3555,3558,3560,3563,3565,3568,3571,3573,3576,3578,
  3581,3583,3586,3589,3591,3594,3596,3599,3601,3604,3607,3609,3612,3614,3617,3619,
  3622,3625,3627,3630,3632,3635,3638,3640,3643,3645,3648,3651,3653,3656,3658,3661,
  3664,3666,3669,3671,3674,3677,3679,3682,3684,3687,3690,3692,3695,3698,3700,3703,
  3705,3708,3711,3713,3716,3719,3721,3724,3726,3729,3732,3734,3737,3740,3742,3745,
  3748,3750,3753,3756,3758,3761,3763,3766,3769,3771,3774,3777,3779,3782,3785,3787,
  3790,3793,3795,3798,3801,3803,3806,3809,3811,3814,3817,3819,3822,3825,3827,3830,
  3833,3836,3838,3841,3844,3846,3849,3852,3854,3857,3860,3862,3865,3868,3871,3873,
  3876,3879,3881,3884,3887,3889,3892,3895,3898,3900,3903,3906,3908,3911,3914,3917,
  3919,3922,3925,3927,3930,3933,3936,3938,3941,3944,3947,3949,3952,3955,3958,3960,
  3963,3966,3968,3971,3974,3977,3979,3982,3985,3988,3990,3993,3996,3999,4002,4004,
  4007,4010,4013,4015,4018,4021,4024,4026,4029,4032,4035,4037,4040,4043,4046,4049,
  4051,4054,4057,4060,4062,4065,4068,4071,4074,4076,4079,4082,4085,4088,4090,4093,
  4096 };

/**
 * \brief Set value (0-4096)
 */
int
value_hard_RGB(uint16_t R,uint16_t G,uint16_t B, uint16_t brightness)
{

	if(brightness>128)
		brightness = 128;

	PWM->PWM_CH_NUM[1].PWM_CDTYUPD = (uint32_t)(gamma_table[R]*brightness)>>7; // divide by 128
	PWM->PWM_CH_NUM[2].PWM_CDTYUPD = (uint32_t)(gamma_table[G]*brightness)>>7; // divide by 128
	PWM->PWM_CH_NUM[3].PWM_CDTYUPD = (uint32_t)(gamma_table[B]*brightness)>>7; // divide by 128

	sensors_changed(&hard_RGB_ctrl_sensor);
	return 1;
}

//NB: value must be an address to the variable that holds the RGB values
int
hard_RGB_set(int value_addr)
{
	RGB_hard_t *temp = (RGB_hard_t *)value_addr;
	if(value_addr != SENSOR_ERROR){
		hard_user_set.all = temp->all;
		value_hard_RGB(hard_user_set.led.r,hard_user_set.led.g,hard_user_set.led.b,hard_user_set.led.brightness);
	}
	return (int)&hard_user_set.all;
}
/*---------------------------------------------------------------------------*/
int
configure_hard_RGB(void)
{
	uint32_t clk_config;
	pmc_enable_periph_clk(ID_PWM);
	PWM->PWM_DIS = (1<<0) | (1<<1) | (1<<2) | (1<<3);
	PWM->PWM_OOV=0; // overwrite to low
	PWM->PWM_OS = (1<<3) | (1<<2) | (1<<17); // Set all PWM (high and low) to low level

	REG_CCFG_SYSIO = PIO_PB4;

	pio_set_peripheral(PIOA, PIO_PERIPH_B, PIO_PA20); 	// pwm1L -> R
	pio_set_peripheral(PIOA, PIO_PERIPH_B, PIO_PA7); 	// pwm3H -> B
	pio_set_peripheral(PIOB, PIO_PERIPH_B, PIO_PB4);	// pwm2H -> G

	// PWM clock = 3.75MHz
#if !LOW_CLOCK //120Mhz
	clk_config = (5<<0); //CLKA no divide mck/32
#else //30Mhz
	clk_config = (3<<0); //CLKA no divide mck/8
#endif

	// 3.75MHz/4096 = 915.5Hz => more that enough
	PWM->PWM_CH_NUM[1].PWM_CPRD = 4096;
	PWM->PWM_CH_NUM[1].PWM_CDTY = 0;
	PWM->PWM_CH_NUM[1].PWM_CMR = clk_config;

	PWM->PWM_CH_NUM[2].PWM_CPRD = 4096;
	PWM->PWM_CH_NUM[2].PWM_CDTY = 0;
	PWM->PWM_CH_NUM[2].PWM_CMR = (1<<17) | clk_config;

	PWM->PWM_CH_NUM[3].PWM_CPRD = 4096;
	PWM->PWM_CH_NUM[3].PWM_CDTY = 0;
	PWM->PWM_CH_NUM[3].PWM_CMR = (1<<17) | clk_config;

	return 1;
}
/*---------------------------------------------------------------------------*/
/**
 * \brief Configuration function for the sensor.
 *
 * \param type Activate, enable or disable the sensor. See below
 * \param enable
 *
 * When type == SENSORS_HW_INIT we turn on the hardware
 * When type == SENSORS_ACTIVE and enable==1 we enable the sensor
 * When type == SENSORS_ACTIVE and enable==0 we disable the sensor
 */
static int
hard_RGB_init(int type, int enable)
{
	switch(type) {

		case SENSORS_HW_INIT:
			configure_hard_RGB();
			Sensor_status = SENSOR_STATUS_INITIALISED;

			break;

		case SENSORS_ACTIVE:
			if(Sensor_status == SENSOR_STATUS_DISABLED)
				return SENSOR_STATUS_DISABLED;

			 if(enable) {
				 PWM->PWM_ENA = (1<<1) | (1<<2) | (1<<3);
				 PWM->PWM_OSC = (1<<3) | (1<<2) | (1<<17); // Remove overwrite (0 to pwm)
				 Sensor_status = SENSOR_STATUS_READY;
				 RGB_TEST(NULL);
			 } else {
				 PWM->PWM_DIS = (1<<1) | (1<<2) | (1<<3);
				 PWM->PWM_OSS = (1<<3) | (1<<2) | (1<<17); // Apply overwrite (pwm to 0)
				 Sensor_status = SENSOR_STATUS_INITIALISED;
			 }
			break;
	}
	return Sensor_status;
}
/*---------------------------------------------------------------------------*/
static int
hard_RGB_status(int type)
{
	return Sensor_status;
}
/*---------------------------------------------------------------------------*/
SENSORS_SENSOR(hard_RGB_ctrl_sensor, "RGB", hard_RGB_set, hard_RGB_init, hard_RGB_status);
/*---------------------------------------------------------------------------*/

struct ctimer RGB_timer;

unsigned state = 43;
RGB_hard_t RGB_tmp;

static void
RGB_TEST(void *data)
{
	clock_time_t next = 4;
	if(state == 43)
	{
		state = 0;
		RGB_tmp.led.brightness = 128;
	}
	switch(state)
	{
		case 0:
			if(RGB_tmp.led.b) 			RGB_tmp.led.b--;
			if(++RGB_tmp.led.r == 4096)	state++;
			break;

		case 1:
			if(RGB_tmp.led.r) 			RGB_tmp.led.r--;
			if(++RGB_tmp.led.g == 4096)	state++;
			break;

		case 2:
			if(RGB_tmp.led.g) 			RGB_tmp.led.g--;
			if(++RGB_tmp.led.b == 4096)	state = 0;
			break;
	}
	value_hard_RGB(RGB_tmp.led.r,RGB_tmp.led.g,RGB_tmp.led.b,RGB_tmp.led.brightness);
	ctimer_set(&RGB_timer, next, RGB_TEST, NULL);
}

/*---------------------------------------------------------------------------*/
#endif
